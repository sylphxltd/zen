# Zen v3.5.0 Release Notes ğŸ‰

## Performance Breakthrough: 2.97x vs Solid.js!

We're excited to announce Zen v3.5.0, which achieves a **massive 65.5% performance improvement** over v3.4, bringing Zen to **2.97-3.13x slower than Solid.js** - exceeding our 3-5x target!

### ğŸš€ Performance Results

| Test Case | v3.4 | v3.5 | Improvement |
|-----------|------|------|-------------|
| Unobserved computed | 9.70x | 4.04x | **62.7% faster** |
| Observed computed | 8.37x | 2.48x | **69.3% faster** |
| Batch overhead | 7.80x | 2.88x | **65.1% faster** |
| **Average** | **8.62x** | **3.13x** | **65.5% faster** |

### ğŸ“¦ Bundle Size

- **Brotli**: 1.96 KB (v3.4: 1.8 KB)
- **Gzip**: 2.21 KB (v3.4: 2.06 KB)
- **Trade-off**: +7-9% size for **65.5% performance** âœ…

### âš¡ What's New

#### 1. Inline Object.is (1-2% impact)

Eliminated function call overhead by inlining equality checks:

```typescript
// Before
if (Object.is(newValue, oldValue)) return;

// After
if (newValue === oldValue && (newValue !== 0 || 1/newValue === 1/oldValue)) return;
if (newValue !== newValue && oldValue !== oldValue) return;
```

Correctly handles both NaN and +0/-0 edge cases while avoiding function call overhead.

#### 2. Remove pendingNotifications Map (40%+ impact!) ğŸ”¥

**The biggest single optimization!** Replaced Map-based notification queue with direct object properties + Array:

```typescript
// Before: Map overhead
const pendingNotifications = new Map<AnyZen, any>();
if (!pendingNotifications.has(zen)) {
  pendingNotifications.set(zen, oldValue);
}

// After: Direct property + Array
zen._pendingOldValue = oldValue;
pendingSignals.push(zen);
```

**Key insight**: Map.has + Map.set in the hot path was the major bottleneck. Using object properties is much faster.

#### 3. Classify Listeners (25%+ impact!)

Separated computed listeners from effect listeners to eliminate type checking in the hot path:

```typescript
// Before: Type check every iteration
for (const listener of listeners) {
  const computedZen = (listener as any)._computedZen;
  if (computedZen && !computedZen._dirty) { ... }
}

// After: Pre-classified array
for (const computedZen of _computedListeners) {
  if (!computedZen._dirty) { ... }
}
```

### ğŸ¯ Journey from v3.0 to v3.5

```
v3.0: Initial auto-tracking
v3.1: Basic optimizations
v3.2: Queue reuse (12.8x slower vs Solid)
v3.3: Pull-based lazy (8.9x slower)
v3.4: Epoch + inline (8.6x slower)
v3.5: Signal optimizations (3.1x slower) â† ğŸ‰ Current
```

**Total improvement**: From 12.8x â†’ 3.1x = **76% overall performance gain!**

### ğŸ”¬ Technical Deep Dive

The breakthrough came from analyzing the real bottleneck: **signal write operations** account for 17.73ms out of 20ms total in our benchmarks.

Phase 3 optimizations directly attacked this:
1. **Inline Object.is**: Reduced per-write overhead
2. **Remove Map operations**: Cut 40%+ from hot path
3. **Classified listeners**: Eliminated redundant type checks

See [PHASE3_SUMMARY.md](./PHASE3_SUMMARY.md) for complete technical analysis.

### ğŸ“‹ Breaking Changes

**None!** All optimizations are internal implementation changes.

### ğŸ™ Migration Guide

No migration needed - v3.5 is fully backward compatible with v3.4.

Simply update:
```bash
npm install @sylphx/zen@3.5.0
# or
bun add @sylphx/zen@3.5.0
```

### ğŸ”® What's Next?

Zen v3.5 has achieved competitive performance with Solid.js! Future optimizations would require breaking changes (v4.0):

- Unified computed implementation
- Complete Solid-style lazy evaluation
- STALE/PENDING state machine
- Topological sorting for notifications

### ğŸ“Š Benchmark Details

Run benchmarks yourself:
```bash
bun benchmark-phase2-vs-solid.ts
```

Current results (average of multiple runs):
- **Test 1** (Unobserved): Zen 8.43ms vs Solid 2.08ms = 4.04x
- **Test 2** (Observed): Zen 6.01ms vs Solid 2.43ms = 2.48x
- **Test 3** (Pure overhead): Zen 5.45ms vs Solid 1.89ms = 2.88x

### ğŸ‰ Acknowledgments

Thanks to the Solid.js team for inspiration and the excellent reactive primitives design!

---

**Full Changelog**: https://github.com/SylphxAI/zen/compare/v3.4.0...v3.5.0

**Install**: `npm install @sylphx/zen@3.5.0`

**Documentation**: https://github.com/SylphxAI/zen#readme
