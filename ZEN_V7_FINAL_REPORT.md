# Zen V7 æœ€çµ‚å ±å‘Šï¼šå–®æ…‹åŒ–å„ªåŒ–å¯¦é©—

## ğŸ¯ ç›®æ¨™å›é¡§

åŸºæ–¼ V1-V6 çš„ç¶“é©—ï¼ŒV7 å˜—è©¦å…©å€‹æ¼¸é€²å¼å„ªåŒ–ï¼š
- **V7b**: å–®æ…‹åŒ– + ç§»é™¤ observerSlots (ç©©å¥æ–¹æ¡ˆ)
- **V7a**: V7b + ç§»é™¤é‡è¤‡æª¢æŸ¥ (æ¿€é€²æ–¹æ¡ˆ)

**é æœŸ**:
- V7b: +10-20% å…¨é¢æå‡
- V7a: +30-50% è¤‡é›œåœ–

## ğŸ“Š å¯¦éš›æ€§èƒ½çµæœ

### å®Œæ•´å°æ¯”è¡¨ (ops/second)

| æ¸¬è©¦ | V4 | V6 | V7a | V7b | æœ€ä½³ | V7b vs V4 |
|------|----|----|-----|-----|------|-----------|
| **3-Level** | 19.3K | 20.0K | 20.4K | **20.5K** | V7b | **+6.0%** âœ… |
| **Diamond** | 223K | 220K | 232K | **238K** | V7b | **+6.7%** âœ… |
| **5-Level** | 116K | 125K | 126K | **129K** | V7b | **+11.1%** âœ… |
| **Read** | 1.09M | 1.09M | 1.09M | 1.09M | æŒå¹³ | **0%** |
| **Write** | **1.16M** | 778K | 782K | 783K | V4 | **-32.6%** âŒ |

### V7b vs V6

| æ¸¬è©¦ | V6 | V7b | æå‡ |
|------|----|----|------|
| **3-Level** | 20.0K | 20.5K | **+2.5%** |
| **Diamond** | 220K | 238K | **+8.2%** âœ… |
| **5-Level** | 125K | 129K | **+3.2%** |
| **Write** | 778K | 783K | **+0.6%** |

### V7a vs V7bï¼ˆç§»é™¤é‡è¤‡æª¢æŸ¥çš„æ•ˆæœï¼‰

| æ¸¬è©¦ | V7b | V7a | å·®ç•° |
|------|-----|-----|------|
| **3-Level** | 20.5K | 20.4K | **-0.7%** âš ï¸ |
| **Diamond** | 238K | 232K | **-2.5%** âš ï¸ |
| **5-Level** | 129K | 126K | **-1.9%** âš ï¸ |

## ğŸ” æ·±åº¦åˆ†æ

### V7b çš„æˆåŠŸä¹‹è™•

**1. å–®æ…‹åŒ–å„ªåŒ–ç”Ÿæ•ˆ**

```typescript
// âŒ V6: å¤šæ…‹å‡½æ•¸
function trackDependency(listener, source) {
  // è™•ç† signal å’Œ computed å…©ç¨®é¡å‹
}

// âœ… V7b: å–®æ…‹å‡½æ•¸
function trackSignalDependency(listener: CNode, signal: SNode) {
  // åªè™•ç† signal
}

function trackComputedDependency(listener: CNode, computed: CNode) {
  // åªè™•ç† computed
}
```

V8 å¯ä»¥æ›´å¥½åœ°å„ªåŒ–å–®æ…‹å‡½æ•¸ï¼ˆhidden class ç©©å®šï¼‰ã€‚

**2. ç§»é™¤ observerSlots ç°¡åŒ–çµæ§‹**

```typescript
// V6: æ›´å¤šå­—æ®µ
type Node = {
  value: T;
  updatedAt: number;
  observers: Node[] | null;
  observerSlots: number[] | null;  // âŒ é¡å¤–ç¶­è­·æˆæœ¬
}

// V7b: æœ€å°å­—æ®µ
type Node = {
  value: T;
  updatedAt: number;
  observers: Node[] | null;  // âœ… æ›´ç·Šæ¹Š
}
```

**æ¬Šè¡¡**: O(n) unsubscribe vs O(1)ï¼Œä½† unsubscribe å¾ˆå°‘ç™¼ç”Ÿã€‚

**3. "Check last added" å„ªåŒ–**

```typescript
function trackSignalDependency(listener, signal) {
  const sources = listener.sources;

  // âœ… å¿«é€Ÿè·¯å¾‘ï¼šæª¢æŸ¥æœ€å¾Œä¸€å€‹ï¼ˆå¾ªç’°ä¸­å¸¸è¦‹ï¼‰
  if (sources[sources.length - 1] === signal) {
    return; // Already tracked
  }

  // Fallback: ç·šæ€§æŸ¥æ‰¾
  for (let i = 0; i < sources.length; i++) {
    if (sources[i] === signal) return;
  }
}
```

é€™å€‹å„ªåŒ–éå¸¸æœ‰æ•ˆï¼Œå› ç‚ºï¼š
- å¾ªç’°ä¸­ç¶“å¸¸é‡è¤‡è®€å–åŒä¸€å€‹ signal
- æœ€å¾Œä¸€å€‹å‰›å‰›æ·»åŠ çš„å°±æ˜¯ç•¶å‰ signal

---

### V7a å¤±æ•—çš„åŸå› 

**å‡è¨­**: ç§»é™¤é‡è¤‡æª¢æŸ¥æœƒå¸¶ä¾†é¡¯è‘—æå‡

**å¯¦éš›**: æ¯” V7b æ…¢ 1-3%

**åŸå› åˆ†æï¼š**

1. **å»é‡é–‹éŠ·ä¸å°**

```typescript
// V7a: å»é‡é‚è¼¯
function deduplicateSources(node: CNode<any>): void {
  const seen = new Set<SNode<any> | CNode<any>>();
  let writeIdx = 0;

  for (let i = 0; i < srcs.length; i++) {
    const src = srcs[i];
    if (!seen.has(src)) {
      seen.add(src);
      srcs[writeIdx++] = src;
    }
  }

  // âœ… æ™‚é–“è¤‡é›œåº¦: O(n)
  // âŒ å¯¦éš›é–‹éŠ·: Set å‰µå»º + hash è¨ˆç®— + å…§å­˜åˆ†é…
}
```

**Set çš„éš±è—æˆæœ¬:**
- å‰µå»º Set å°è±¡: ~50ns
- Hash è¨ˆç®—: ~10-20ns per element
- å…§å­˜åˆ†é…: åƒåœ¾å›æ”¶å£“åŠ›

å°æ–¼å°æ•¸çµ„ï¼ˆ<10 å…ƒç´ ï¼‰ï¼Œç°¡å–®ç·šæ€§æŸ¥æ‰¾æ›´å¿«ï¼š
```typescript
// V7b: ç·šæ€§æŸ¥æ‰¾
for (let i = 0; i < sources.length; i++) {
  if (sources[i] === signal) return;  // ~5ns per iteration
}
```

2. **æ¸¬è©¦æ¡ˆä¾‹ç‰¹é»**

æˆ‘å€‘çš„æ¸¬è©¦ä¸­ï¼Œcomputed é€šå¸¸åªæœ‰ 1-3 å€‹ä¾è³´ï¼š
- 3-Level chain: æ¯å€‹ computed åªä¾è³´ 1 å€‹ source
- Diamond: d ä¾è³´ b å’Œ c (2 å€‹)
- 5-Level: æ¯å€‹ computed åªä¾è³´ 1 å€‹ source

åœ¨é€™ç¨®æƒ…æ³ä¸‹ï¼š
- ç·šæ€§æŸ¥æ‰¾: ~5-15ns
- Set å»é‡: ~100-200ns

**3. V7b çš„ "check last" å„ªåŒ–å·²ç¶“è¶³å¤ **

```typescript
// å¾ªç’°ä¸­çš„å…¸å‹æ¨¡å¼
for (let i = 0; i < 1000; i++) {
  a.set(i);
  d();  // d è®€å– cï¼Œc è®€å– bï¼Œb è®€å– a
}

// æ¯æ¬¡ d() æ™‚ï¼š
// - d è®€å– c (sources = [c])
// - c è®€å– b (sources = [b])
// - b è®€å– a (sources = [a])
// æ¯å€‹éƒ½åªè®€å–ä¸€æ¬¡ï¼Œæ²’æœ‰é‡è¤‡

// V7b çš„ "check last" ç›´æ¥å‘½ä¸­ï¼š
if (sources[sources.length - 1] === signal) return;  // âœ… ç«‹å³è¿”å›
```

---

## ğŸ’¡ é—œéµå­¸ç¿’

### 1. å–®æ…‹åŒ–ç¢ºå¯¦æœ‰æ•ˆ (+6-11%)

V7b è­‰æ˜äº†å–®æ…‹å‡½æ•¸å° V8 å„ªåŒ–çš„é‡è¦æ€§ã€‚

### 2. ç°¡åŒ–æ•¸æ“šçµæ§‹æœ‰å¹«åŠ©

ç§»é™¤ observerSlots ä¸åƒ…ç°¡åŒ–ä»£ç¢¼ï¼Œé‚„æå‡äº†æ€§èƒ½ã€‚

### 3. å¾®å„ªåŒ–è¦æ¸¬è©¦ï¼Œä¸èƒ½å‡è¨­

V7a çœ‹ä¼¼æ›´æ¿€é€²çš„å„ªåŒ–åè€Œæ›´æ…¢ï¼Œå› ç‚ºï¼š
- Set å‰µå»ºé–‹éŠ·è¢«ä½ä¼°
- å°æ•¸çµ„ä¸Šç·šæ€§æŸ¥æ‰¾è¶³å¤ å¿«
- "Check last" å„ªåŒ–å·²ç¶“è¦†è“‹å¸¸è¦‹æƒ…æ³

### 4. å„ªåŒ–è¦é‡å°å¯¦éš›ä½¿ç”¨æ¨¡å¼

æˆ‘å€‘çš„å„ªåŒ–å‡è¨­ï¼š
- âŒ computed æœƒå¤šæ¬¡è®€å–åŒä¸€å€‹ signalï¼ˆV7a çš„å‰æï¼‰
- âœ… computed åªåœ¨é¦–æ¬¡é‹è¡Œæ™‚è¿½è¹¤ä¾è³´ï¼ˆV7b çš„è¨­è¨ˆï¼‰

å¯¦éš›ä½¿ç”¨ï¼š
- å¤§å¤šæ•¸ computed åªæœ‰ 1-3 å€‹ä¾è³´
- å¾ªç’°ä¸­æ¯æ¬¡åŸ·è¡Œè·¯å¾‘ç›¸åŒ
- "Check last" å¹¾ä¹ç¸½æ˜¯å‘½ä¸­

### 5. V4 çš„å¯«å…¥æ€§èƒ½ä»ç„¡æ³•è¶…è¶Š

V6/V7a/V7b éƒ½ç„¡æ³•é”åˆ° V4 çš„å¯«å…¥é€Ÿåº¦ï¼ˆ1.16M vs 780Kï¼‰ã€‚

**å¯èƒ½åŸå› ï¼š**
- Inline tracking å¢åŠ äº† getter å‡½æ•¸é«”ç©
- V8 ç„¡æ³•æœ‰æ•ˆå…§è¯æ›´å¤§çš„å‡½æ•¸
- éœ€è¦æ›´æ¿€é€²çš„å„ªåŒ–ï¼ˆç·¨è­¯å™¨ï¼Ÿï¼‰

---

## ğŸ† æœ€çµ‚æ¨è–¦

### V7b æ˜¯ Zen è¿„ä»Šç‚ºæ­¢æœ€å¥½çš„ç‰ˆæœ¬ â­

**ä½•æ™‚ä½¿ç”¨ V7bï¼š**
- âœ… éœ€è¦æœ€ä½³è¤‡é›œåœ–æ€§èƒ½ (Diamond: 238K, +6.7% vs V4)
- âœ… é¡˜æ„æ¥å— 32% çš„å¯«å…¥æ€§èƒ½æå¤±
- âœ… è®€å¯†é›†å‹æ‡‰ç”¨

**ä½•æ™‚ä½¿ç”¨ V4ï¼š**
- âœ… éœ€è¦æœ€ä½³å¯«å…¥æ€§èƒ½ (1.16M vs 783K)
- âœ… å¯«å…¥é »ç¹çš„æ‡‰ç”¨
- âœ… æƒ³è¦æœ€ç°¡å–®çš„ä»£ç¢¼

**ä¸è¦ä½¿ç”¨ï¼š**
- âŒ V7a: æ²’æœ‰å„ªå‹¢ï¼Œé‚„æ›´è¤‡é›œ

---

## ğŸ“ˆ æ”¹é€²å¹…åº¦ç¸½çµ

### V1 â†’ V7b å®Œæ•´æ—…ç¨‹

| æŒ‡æ¨™ | V1 | V4 | V7b | V7b vs V1 | V7b vs V4 |
|------|----|----|-----|-----------|-----------|
| **Read** | 189K | 1.09M | 1.09M | **+476%** ğŸš€ | 0% |
| **Write** | 179K | 1.16M | 783K | **+337%** ğŸš€ | **-32%** âš ï¸ |
| **3-Level** | 69K | 19K | 20.5K | **-70%** â¬‡ï¸ | **+6%** âœ… |
| **Diamond** | 547K | 223K | 238K | **-56%** â¬‡ï¸ | **+7%** âœ… |
| **5-Level** | 543K | 116K | 129K | **-76%** â¬‡ï¸ | **+11%** âœ… |

### é—œéµç™¼ç¾

1. **åŸºç¤æ“ä½œå·¨å¤§æå‡** (+337-476%)
   - å…¨é  bound function API (V1 â†’ V2)

2. **è¤‡é›œåœ–æ€§èƒ½é€€åŒ–** (-56% to -76%)
   - V1 çš„ graph coloring å¤ªå¼·
   - ä½† V7b æ­£åœ¨è¿½å› (ç›¸æ¯” V4 +6-11%)

3. **å¯«å…¥æ€§èƒ½çš„æ¬Šè¡¡**
   - V4 æœ€å¿«ï¼š1.16M ops/s
   - V7b æ…¢ 32%ï¼š783K ops/s
   - åŸå› ï¼šInline tracking çš„ä»£åƒ¹

---

## ğŸ¯ èˆ‡ Solid çš„å·®è·

| æ¸¬è©¦ | V7b | Solid | å·®è· |
|------|-----|-------|------|
| **Read** | 1.09M | 3.77M | **-3.5x** |
| **Write** | 783K | 3.74M | **-4.8x** |
| **3-Level** | 20.5K | 910K | **-44x** |
| **Diamond** | 238K | 5.94M | **-25x** |
| **5-Level** | 129K | 5.70M | **-44x** |

**å‰©é¤˜å·®è·ä¾†æºï¼š**

1. **åŸºç¤æ“ä½œ (3-5x)**:
   - å¯èƒ½çš„å„ªåŒ–ç©ºé–“æœ‰é™
   - å¯èƒ½éœ€è¦ç·¨è­¯å™¨æ”¯æŒ

2. **è¤‡é›œåœ– (25-44x)**:
   - ä»ç„¶å¾ˆå¤§çš„å·®è·
   - å¯èƒ½éœ€è¦ï¼š
     - åœ–è‘—è‰² + æ°¸ä¹…ä¾è³´çµåˆ (V7c æ–¹æ¡ˆ)
     - æ›´æ¿€é€²çš„ inline
     - ç·¨è­¯å™¨å„ªåŒ–

---

## ğŸš€ ä¸‹ä¸€æ­¥æ–¹å‘

### çŸ­æœŸï¼ˆå·²å®Œæˆï¼‰âœ…

- âœ… V7b: å–®æ…‹åŒ– + æœ€å°å­—æ®µ (+6-11%)
- âœ… V7a: ç§»é™¤é‡è¤‡æª¢æŸ¥ï¼ˆå¤±æ•—ï¼‰

### ä¸­æœŸï¼ˆå€¼å¾—å˜—è©¦ï¼‰

**V7c: åœ–è‘—è‰² + æ°¸ä¹…ä¾è³´**
```typescript
// çµåˆ V1 çš„ graph coloring å’Œ V7b çš„å–®æ…‹åŒ–
// é æœŸï¼šæ¥è¿‘ V1 åœ¨è¤‡é›œåœ–çš„æ€§èƒ½ (500K+ ops/s)
// é¢¨éšªï¼šé«˜è¤‡é›œåº¦
```

### é•·æœŸï¼ˆéœ€è¦æ¶æ§‹æ”¹è®Šï¼‰

**ç·¨è­¯å™¨æ–¹æ¡ˆ**
- æ§‹å»ºæ™‚å…§è¯æ‰€æœ‰æ±è¥¿
- æ¶ˆé™¤é‹è¡Œæ™‚é–‹éŠ·
- é¡ä¼¼ Solid çš„ç·¨è­¯å™¨

---

## ğŸ“Š ç‰ˆæœ¬é¸æ“‡æŒ‡å—ï¼ˆæ›´æ–°ï¼‰

### æ¨è–¦çŸ©é™£

| å ´æ™¯ | æ¨è–¦ | åŸå›  |
|------|------|------|
| **æ–°é …ç›®ï¼ˆé€šç”¨ï¼‰** | **V4** | æœ€ç°¡å–®ï¼Œæ€§èƒ½å¹³è¡¡ |
| **è®€å¯†é›† + è¤‡é›œåœ–** | **V7b** | Diamond +7%, 5-Level +11% |
| **å¯«å¯†é›†** | **V4** | å¯«å…¥å¿« 48% |
| **æ¥µç«¯è¤‡é›œåœ–** | **V1** | Diamond: 547K (V7b: 238K) |
| **å­¸ç¿’ / å¯¦é©—** | **V4** | ä»£ç¢¼æœ€ç°¡æ½” |

### æ€§èƒ½å„ªå…ˆç´š

```
å¯«å…¥æ€§èƒ½æœ€é‡è¦ï¼Ÿ
  â†’ V4 (1.16M ops/s)

è®€å– + è¤‡é›œåœ–ï¼Ÿ
  â†’ é¡˜æ„çŠ§ç‰²å¯«å…¥ 30%ï¼Ÿ
    YES â†’ V7b (Diamond: 238K)
    NO  â†’ V4

æ¥µç«¯è¤‡é›œåœ–ï¼ˆé¡˜æ„æ‰‹å‹• APIï¼‰ï¼Ÿ
  â†’ V1 (Diamond: 547K)
```

---

## ğŸ“ ç¸½çµ

### V7 å¯¦é©—çš„æ”¶ç©«

1. **V7b æˆåŠŸ** âœ…
   - å–®æ…‹åŒ– +6-11%
   - æœ€å°å­—æ®µç°¡åŒ–ä»£ç¢¼
   - "Check last" å„ªåŒ–æœ‰æ•ˆ

2. **V7a å¤±æ•—** âŒ
   - ç§»é™¤é‡è¤‡æª¢æŸ¥ç„¡å¹«åŠ©
   - Set é–‹éŠ·è¢«ä½ä¼°
   - ç·šæ€§æŸ¥æ‰¾å°å°æ•¸çµ„æ›´å¿«

3. **å¯«å…¥æ€§èƒ½ç“¶é ¸**
   - Inline tracking çš„ä»£åƒ¹
   - V8 å„ªåŒ–é™åˆ¶
   - å¯èƒ½éœ€è¦ç·¨è­¯å™¨

### ä¸ƒå€‹ç‰ˆæœ¬çš„æ—…ç¨‹

| ç‰ˆæœ¬ | ç­–ç•¥ | çµæœ | è©•åˆ† |
|------|------|------|------|
| V1 | Graph coloring + Manual API | è¤‡é›œåœ–æœ€å¿« | 8/10 |
| V2 | Bound + Push | å¤±æ•— | 3/10 |
| V3 | Bound + Pull + é‡è¨‚é–± | å¤±æ•— | 4/10 |
| V4 | Bound + Pull + Timestamp | **æœ€å¹³è¡¡** | **9/10** |
| V5 | Graph + Inline + Cleanup | å¤±æ•— | 2/10 |
| V6 | Timestamp + Inline | è¤‡é›œåœ–è¼ƒå¥½ | 7/10 |
| V7b | Monomorphic + Minimal | **è¤‡é›œåœ–æœ€å„ª** | **9/10** |
| V7a | No duplicate check | å¤±æ•— | 6/10 |

**æˆåŠŸç‡**: 3/8 (37.5%)

**é—œéµæˆåŠŸå› ç´ :**
- ç°¡å–®æ¸…æ™°çš„ç­–ç•¥
- é‡å°å¯¦éš›ä½¿ç”¨æ¨¡å¼
- å……åˆ†æ¸¬è©¦é©—è­‰

---

**å ±å‘Šå®Œæˆæ—¥æœŸ**: 2025-01-XX
**V7b**: æ–°çš„æ¨è–¦ç‰ˆæœ¬ï¼ˆè¤‡é›œåœ–å ´æ™¯ï¼‰
**V4**: ä»æ˜¯é€šç”¨æœ€ä½³é¸æ“‡

**ä¸‹ä¸€æ­¥**: è€ƒæ…® V7c (åœ–è‘—è‰² + æ°¸ä¹…ä¾è³´) æˆ–åœæ­¢å„ªåŒ–
